<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>๐ ุงุฎุชุจุงุฑ ุญูุธ ุงููุฑุขู ุงููุฑูู โ ุงูุตู ุงูุฃูู ุงูุซุงููู (ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู)</title>
<style>
  :root{
    --bg:#eaf4ec;            /* ุฃุฎุถุฑ ูุงุชุญ ุจููู ุงููุตุญู ุงููุฏุฑุณู */
    --fg:#1f2937;
    --green:#197a3a;         /* ุฃุฎุถุฑ ุฏุงูู ููุนูุงููู ูุงูุฃุฒุฑุงุฑ ูุงููุคูุช */
    --green-soft:#2aa15a;
    --card:#ffffff;
    --muted:#6b7280;
    --shadow:0 10px 24px rgba(0,0,0,.08);
    --ok:#16a34a; --bad:#ef4444; --accent:#e3b04b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:"Amiri","Noto Naskh Arabic",system-ui,-apple-system,"Segoe UI",sans-serif}
  header{padding:22px 16px;text-align:center}
  h1{margin:0 0 6px;font-size:26px;color:var(--green)}
  .sub{color:var(--muted)}
  .wrap{max-width:960px;margin:0 auto;padding:0 16px 28px}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px;margin:14px auto}
  .center{text-align:center}
  .btn{border:none;border-radius:12px;padding:12px 18px;font-size:16px;cursor:pointer}
  .btn-green{background:var(--green);color:#fff}
  .btn-green-soft{background:var(--green-soft);color:#fff}
  .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:var(--fg)}
  .btn-accent{background:var(--accent)}
  .btn-ok{background:var(--ok);color:#fff}
  .btn-bad{background:var(--bad);color:#fff}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .note{color:var(--muted);font-size:14px}
  .timer{font-weight:700;color:var(--green);font-size:18px;margin-bottom:10px}
  .big{font-size:20px;line-height:2}
  .hidden-ellipses{color:#94a3b8}
  .pill{display:inline-block;background:#fff;border:1px solid #d1d5db;color:var(--green);border-radius:999px;padding:6px 10px;font-size:13px}
  #introView, #selectView, #quizView, #resultView{display:none}
  .ck{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .ck input{width:20px;height:20px}
  .list{list-style:none;padding:0;margin:0}
  .list li{margin:6px 0}
</style>
</head>
<body>

<header>
  <h1>๐ ุงุฎุชุจุงุฑ ุญูุธ ุงููุฑุขู ุงููุฑูู โ ุงูุตู ุงูุฃูู ุงูุซุงููู (ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู)</h1>
  <div class="sub">ูู ุฅุนุฏุงุฏ ุงููุนูู <b>ุนุจุฏ ุงููู ุจู ุญุณูู ุงููุญุทุงูู</b> โ ูุฏุฑุณุฉ ุงููุฌูุฏูุฉ ุงูุซุงูููุฉ ุจุงููุทูู</div>
</header>

<div class="wrap">

  <!-- ุตูุญุฉ ุงูุดุฑุญ -->
  <section id="introView" class="card">
    <div class="center" style="font-size:42px;line-height:1;margin-bottom:10px;">๐</div>
    <h2 class="center" style="margin-top:0;color:var(--green)">ุทุฑููุฉ ุงุณุชุฎุฏุงู ุงูุงุฎุชุจุงุฑ</h2>
    <div class="grid">
      <p>ูุฐุง ุงูุชุทุจูู ูุณุงุนุฏู ุนูู ูุฑุงุฌุนุฉ ุญูุธู ูููุงุทุน ุงูููุฑุฑ. ุนูุฏ ุจุฏุก ุงูุงุฎุชุจุงุฑ ุณุชุธูุฑ ูู ูุฌููุนุฉ ูููุงุช ูู ุงูููุทุน ุงููุฎุชุงุฑุ ูุงููุทููุจ ุฃู <b>ุชูููู ุซูุงุซ ูููุงุช</b> ูู ุญูุธู ุฎูุงู <b>20 ุซุงููุฉ</b>.</p>
      <ul>
        <li>ุจุนุฏ ุฃู ุชููู ุฅุฌุงุจุชู ุดููููุงุ ุงุถุบุท <b>ยซุฃุธูุฑ ุงูุฅุฌุงุจุฉยป</b> ูุชุฑู ุงููุต ุงูุตุญูุญ.</li>
        <li>ูุงุฑู ุฅุฌุงุจุชู ุซู ุงุฎุชุฑ: <b>โ ุตูุงุจ</b> ุฃู <b>โ ุฎุทุฃ</b>.</li>
        <li>ุจุนุฏ ุขุฎุฑ ุณุคุงู ุณุชุธูุฑ ูู <b>ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</b>ุ ูููููู ุฅุนุงุฏุฉ ุงููุญุงููุฉ.</li>
      </ul>
      <div class="note">ุชุฐููุฑ: ุงููุทููุจ ุฏุงุฆููุง <b>ุฅููุงู ุซูุงุซ ูููุงุช</b> ููุท ุจุนุฏ ุงูููุทุน ุงูุธุงูุฑ.</div>
    </div>
    <div class="center" style="margin-top:14px;">
      <button class="btn btn-green" id="goSelect">ุงุจุฏุฃ ุงุฎุชูุงุฑ ุงูููุทุน</button>
    </div>
  </section>

  <!-- ุงุฎุชูุงุฑ ุนุฏุฉ ููุงุทุน -->
  <section id="selectView" class="card">
    <h2 class="center" style="margin-top:0;color:var(--green)">ุงุฎุชุฑ ููุทุนูุง ุฃู ุฃูุซุฑ (ูฅ ุฃุณุฆูุฉ ููู ููุทุน)</h2>

    <div class="grid grid-2" id="checks">
      <label class="ck"><input type="checkbox" value="hud"/><span>ุณูุฑุฉ ููุฏ (102โ108)</span></label>
      <label class="ck"><input type="checkbox" value="raad"/><span>ุณูุฑุฉ ุงูุฑุนุฏ (8โ13)</span></label>
      <label class="ck"><input type="checkbox" value="ibrahim"/><span>ุณูุฑุฉ ุฅุจุฑุงููู (42โ52)</span></label>
      <label class="ck"><input type="checkbox" value="nahl"/><span>ุณูุฑุฉ ุงููุญู (125โ128)</span></label>
      <label class="ck"><input type="checkbox" value="isra"/><span>ุณูุฑุฉ ุงูุฅุณุฑุงุก (23โ27)</span></label>
    </div>

    <div class="center" style="margin:10px 0;">
      <span class="pill">ุงูุฅุนุฏุงุฏุงุช ุซุงุจุชุฉ: 12 ูููุฉ ุณุคุงู โข 3 ูููุงุช ุฅุฌุงุจุฉ โข 20 ุซุงููุฉ</span>
    </div>

    <div class="center" style="margin-top:10px;">
      <button class="btn btn-green" id="startMulti">ุงุจุฏุฃ ุงูุงุฎุชุจุงุฑ</button>
    </div>
  </section>

  <!-- ุตูุญุฉ ุงูุงุฎุชุจุงุฑ -->
  <section id="quizView" class="card center">
    <div class="timer">โณ ุงูููุช ุงููุชุจูู: <span id="remaining">--</span> ุซุงููุฉ</div>
    <div id="passageTitle" class="note" style="margin-bottom:8px;"></div>
    <div id="questionText" class="big"></div>
    <div class="note" id="progressText" style="margin-top:6px;"></div>
    <div style="margin-top:14px;">
      <button id="flipBtn" class="btn btn-accent">ุฃุธูุฑ ุงูุฅุฌุงุจุฉ</button>
    </div>
    <div id="answerArea" style="display:none;margin-top:12px;">
      <div id="answerText" class="big"></div>
      <div style="margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button id="correctBtn" class="btn btn-ok">โ ุตูุงุจ</button>
        <button id="wrongBtn" class="btn btn-bad">โ ุฎุทุฃ</button>
      </div>
    </div>
  </section>

  <!-- ุตูุญุฉ ุงููุชูุฌุฉ -->
  <section id="resultView" class="card center">
    <h2 style="margin-top:0;color:var(--green)">ูุชูุฌุชู ุงูุชูุตูููุฉ</h2>
    <ul id="breakdown" class="list"></ul>
    <h3 id="finalScore" style="color:var(--green)"></h3>
    <div style="color:var(--green);margin:6px 0;">๐ฟ <em>ุฃุญุณูุช! ูุงุตู ุงููุฑุงุฌุนุฉ ูุชุชูู ุงูุญูุธ ุฃูุซุฑ.</em></div>
    <div class="note">ููููู ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ ูุชูููู ุญูุธู ูุฑุฉ ุฃุฎุฑู.</div>
    <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="backToSelect" class="btn btn-ghost">๐ ุงูุนูุฏุฉ ูุงุฎุชูุงุฑ ุงูููุงุทุน</button>
      <button id="repeatAll" class="btn btn-green">ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ ููุณู</button>
    </div>
  </section>

</div>

<!-- ุชูุจูู ุงูุชูุงุก ุงูููุช -->
<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
/* ===== ุจูุงูุงุช ุงูููุงุทุน (ุจุฏูู ุฃุฑูุงู ุงูุขูุงุช) ===== */
const PASSAGES = {
  hud: {
    title: "ุณูุฑุฉ ููุฏ (102โ108)",
    text: `ููููุฐููฐูููู ุฃูุฎูุฐู ุฑูุจูููู ุฅูุฐูุง ุฃูุฎูุฐู ุงููููุฑูููฐ ูููููู ุธูุงููููุฉู ุฅูููู ุฃูุฎูุฐููู ุฃูููููู ุดูุฏููุฏู
ุฅูููู ููู ุฐููฐูููู ููุขููุฉู ูููููู ุฎูุงูู ุนูุฐูุงุจู ุงููุขุฎูุฑูุฉู ุฐููฐูููู ูููููู ููุฌููููุนู ููููู ุงููููุงุณู ููุฐููฐูููู ูููููู ูููุดููููุฏู
ููููุง ููุคูุฎููุฑููู ุฅููููุง ููุฃูุฌููู ูููุนูุฏููุฏู
ูููููู ููุฃูุชู ููุง ุชูููููููู ููููุณู ุฅููููุง ุจูุฅูุฐููููู ูููููููููู ุดูููููู ููุณูุนููุฏู
ููุฃููููุง ุงูููุฐูููู ุดููููุง ููููู ุงููููุงุฑู ูููููู ูููููุง ุฒููููุฑู ููุดูููููู
ุฎูุงููุฏูููู ูููููุง ููุง ุฏูุงููุชู ุงูุณููููุงููุงุชู ููุงููุฃูุฑูุถู ุฅููููุง ููุง ุดูุงุกู ุฑูุจูููู ุฅูููู ุฑูุจูููู ููุนููุงูู ููููุง ููุฑููุฏู
ููุฃููููุง ุงูููุฐูููู ุณูุนูุฏููุง ููููู ุงููุฌููููุฉู ุฎูุงููุฏูููู ูููููุง ููุง ุฏูุงููุชู ุงูุณููููุงููุงุชู ููุงููุฃูุฑูุถู ุฅููููุง ููุง ุดูุงุกู ุฑูุจูููู ุนูุทูุงุกู ุบูููุฑู ููุฌูุฐููุฐู`
  },
  raad: {
    title: "ุณูุฑุฉ ุงูุฑุนุฏ (8โ13)",
    text: `ุงูููููู ููุนููููู ููุง ุชูุญููููู ููููู ุฃููุซูููฐ ููููุง ุชูุบููุถู ุงููุฃูุฑูุญูุงูู ููููุง ุชูุฒูุฏูุงุฏู ููููููู ุดูููุกู ุนูููุฏููู ุจูููููุฏูุงุฑู
ุนูุงูููู ุงููุบูููุจู ููุงูุดููููุงุฏูุฉู ุงููููุจููุฑู ุงููููุชูุนูุงูู
ุณูููุงุกู ูููููููู ูููู ุฃูุณูุฑูู ุงูููููููู ูููููู ุฌูููุฑู ุจููู ูููููู ูููู ููุณูุชูุฎููู ุจูุงูููููููู ููุณูุงุฑูุจู ุจูุงููููููุงุฑู
ูููู ููุนููููุจูุงุชู ูููู ุจููููู ููุฏููููู ูููููู ุฎููููููู ููุญูููุธูููููู ูููู ุฃูููุฑู ุงูููููู ุฅูููู ุงูููููู ููุง ููุบููููุฑู ููุง ุจููููููู ุญูุชููููฐ ููุบููููุฑููุง ููุง ุจูุฃูููููุณููููู ููุฅูุฐูุง ุฃูุฑูุงุฏู ุงูููููู ุจููููููู ุณููุกูุง ููููุง ููุฑูุฏูู ูููู ููููุง ูููููู ูููู ุฏูููููู ูููู ููุงูู
ูููู ุงูููุฐูู ููุฑูููููู ุงููุจูุฑููู ุฎูููููุง ููุทูููุนูุง ููููููุดูุฆู ุงูุณููุญูุงุจู ุงูุซููููุงูู
ููููุณูุจููุญู ุงูุฑููุนูุฏู ุจูุญูููุฏููู ููุงููููููุงุฆูููุฉู ูููู ุฎููููุชููู ููููุฑูุณููู ุงูุตููููุงุนููู ููููุตููุจู ุจูููุง ูููู ููุดูุงุกู ูููููู ููุฌูุงุฏูููููู ููู ุงูููููู ูููููู ุดูุฏููุฏู ุงููููุญูุงูู`
  },
  ibrahim: {
    title: "ุณูุฑุฉ ุฅุจุฑุงููู (42โ52)",
    text: `ููููุง ุชูุญูุณูุจูููู ุงูููููู ุบูุงููููุง ุนููููุง ููุนููููู ุงูุธููุงููููููู ุฅููููููุง ููุคูุฎููุฑููููู ูููููููู ุชูุดูุฎูุตู ููููู ุงููุฃูุจูุตูุงุฑู
ููููุทูุนูููู ููููููุนูู ุฑูุกููุณููููู ููุง ููุฑูุชูุฏูู ุฅููููููููู ุทูุฑููููููู ููุฃูููุฆูุฏูุชููููู ููููุงุกู
ููุฃูููุฐูุฑู ุงููููุงุณู ูููููู ููุฃูุชูููููู ุงููุนูุฐูุงุจู ููููููููู ุงูููุฐูููู ุธููููููุง ุฑูุจููููุง ุฃูุฎููุฑูููุง ุฅูููููฐ ุฃูุฌููู ููุฑููุจู ููุฌูุจู ุฏูุนูููุชููู ููููุชููุจูุนู ุงูุฑููุณููู ุฃููููููู ุชูููููููุง ุฃูููุณูููุชููู ูููู ููุจููู ููุง ูููููู ูููู ุฒูููุงูู
ููุณูููููุชููู ููู ููุณูุงูููู ุงูููุฐูููู ุธููููููุง ุฃูููููุณููููู ููุชูุจูููููู ูููููู ูููููู ููุนูููููุง ุจููููู ููุถูุฑูุจูููุง ูููููู ุงููุฃูููุซูุงูู
ููููุฏู ููููุฑููุง ููููุฑููููู ููุนูููุฏู ุงูููููู ููููุฑููููู ููุฅููู ููุงูู ููููุฑููููู ููุชูุฒูููู ูููููู ุงููุฌูุจูุงูู
ููููุง ุชูุญูุณูุจูููู ุงูููููู ููุฎููููู ููุนูุฏููู ุฑูุณููููู ุฅูููู ุงูููููู ุนูุฒููุฒู ุฐูู ุงููุชูููุงูู
ูููููู ุชูุจูุฏูููู ุงููุฃูุฑูุถู ุบูููุฑู ุงููุฃูุฑูุถู ููุงูุณููููุงููุงุชู ููุจูุฑูุฒููุง ููููููู ุงููููุงุญูุฏู ุงูููููููุงุฑู
ููุชูุฑูู ุงููููุฌูุฑูููููู ููููููุฆูุฐู ููููุฑููููููู ููู ุงููุฃูุตูููุงุฏู
ุณูุฑูุงุจูููููููู ูููู ููุทูุฑูุงูู ููุชูุบูุดูููฐ ููุฌูููููููู ุงููููุงุฑู
ููููุฌูุฒููู ุงูููููู ููููู ููููุณู ููุง ููุณูุจูุชู ุฅูููู ุงูููููู ุณูุฑููุนู ุงููุญูุณูุงุจู
ูููฐุฐูุง ุจูููุงุบู ููููููุงุณู ููููููููุฐูุฑููุง ุจููู ููููููุนููููููุง ุฃููููููุง ูููู ุฅููููฐูู ููุงุญูุฏู ููููููุฐูููููุฑู ุฃููููู ุงููุฃูููุจูุงุจู`
  },
  nahl: {
    title: "ุณูุฑุฉ ุงููุญู (125โ128)",
    text: `ุงุฏูุนู ุฅูููููฐ ุณูุจูููู ุฑูุจูููู ุจูุงููุญูููููุฉู ููุงููููููุนูุธูุฉู ุงููุญูุณูููุฉู ููุฌูุงุฏููููููู ุจูุงูููุชูู ูููู ุฃูุญูุณููู ุฅูููู ุฑูุจูููู ูููู ุฃูุนููููู ุจููููู ุถูููู ุนููู ุณูุจูููููู ูููููู ุฃูุนููููู ุจูุงููููููุชูุฏูููู
ููุฅููู ุนูุงููุจูุชููู ููุนูุงููุจููุง ุจูููุซููู ููุง ุนููููุจูุชููู ุจููู ููููุฆููู ุตูุจูุฑูุชููู ูููููู ุฎูููุฑู ูููุตููุงุจูุฑูููู
ููุงุตูุจูุฑู ููููุง ุตูุจูุฑููู ุฅููููุง ุจูุงูููููู ููููุง ุชูุญูุฒููู ุนููููููููู ููููุง ุชููู ููู ุถููููู ูููููุง ููููููุฑูููู
ุฅูููู ุงูููููู ููุนู ุงูููุฐูููู ุงุชููููููุง ููุงูููุฐูููู ูููู ููุญูุณูููููู`
  },
  isra: {
    title: "ุณูุฑุฉ ุงูุฅุณุฑุงุก (23โ27)",
    text: `ููููุถูููฐ ุฑูุจูููู ุฃููููุง ุชูุนูุจูุฏููุง ุฅููููุง ุฅููููุงูู ููุจูุงููููุงููุฏููููู ุฅูุญูุณูุงููุง ุฅููููุง ููุจูููุบูููู ุนูููุฏููู ุงููููุจูุฑู ุฃูุญูุฏูููููุง ุฃููู ููููุงููููุง ููููุง ุชููููู ููููููุง ุฃูููู ููููุง ุชูููููุฑูููููุง ูููููู ููููููุง ููููููุง ููุฑููููุง
ููุงุฎูููุถู ููููููุง ุฌูููุงุญู ุงูุฐููููู ูููู ุงูุฑููุญูููุฉู ูููููู ุฑูุจูู ุงุฑูุญูููููููุง ููููุง ุฑูุจููููุงููู ุตูุบููุฑูุง
ุฑูุจูููููู ุฃูุนููููู ุจูููุง ููู ูููููุณููููู ุฅููู ุชูููููููุง ุตูุงููุญูููู ููุฅูููููู ููุงูู ููููุฃููููุงุจูููู ุบููููุฑูุง
ููุขุชู ุฐูุง ุงููููุฑูุจูููฐ ุญูููููู ููุงููููุณูููููู ููุงุจููู ุงูุณููุจูููู ููููุง ุชูุจูุฐููุฑู ุชูุจูุฐููุฑูุง
ุฅูููู ุงููููุจูุฐููุฑูููู ููุงูููุง ุฅูุฎูููุงูู ุงูุดููููุงุทูููู ููููุงูู ุงูุดููููุทูุงูู ููุฑูุจูููู ูููููุฑูุง`
  }
};

/* ุฅุนุฏุงุฏุงุช ุซุงุจุชุฉ */
const prefix = 12, suffix = 3, perPassageQuestions = 5, timerSeconds = 20;

/* ุนูุงุตุฑ DOM */
const introView  = document.getElementById('introView');
const selectView = document.getElementById('selectView');
const quizView   = document.getElementById('quizView');
const resultView = document.getElementById('resultView');

const goSelectBtn = document.getElementById('goSelect');
const startMulti  = document.getElementById('startMulti');

const questionText = document.getElementById('questionText');
const answerArea   = document.getElementById('answerArea');
const answerText   = document.getElementById('answerText');
const progressText = document.getElementById('progressText');
const remainingEl  = document.getElementById('remaining');
const passageTitle = document.getElementById('passageTitle');

const flipBtn = document.getElementById('flipBtn');
const okBtn   = document.getElementById('correctBtn');
const badBtn  = document.getElementById('wrongBtn');

const breakdown  = document.getElementById('breakdown');
const finalScore = document.getElementById('finalScore');
const backToSelect = document.getElementById('backToSelect');
const repeatAll    = document.getElementById('repeatAll');

const beep = document.getElementById('beep');

/* ุญุงูุฉ ุงูุงุฎุชุจุงุฑ */
let selectedKeys = [];
let currentPassageIdx = 0;
let currentQIdx = 0;
let indicesMap = {};     // key -> indices array
let wordsMap = {};       // key -> words array
let scores = {};         // key -> {title, correct, total}

/* ูุคูุช */
let remaining = timerSeconds;
let timerId = null;

/* ุฅุธูุงุฑ/ุฅุฎูุงุก */
function show(id){
  introView.style.display  = (id==='intro')  ? 'block' : 'none';
  selectView.style.display = (id==='select') ? 'block' : 'none';
  quizView.style.display   = (id==='quiz')   ? 'block' : 'none';
  resultView.style.display = (id==='result') ? 'block' : 'none';
}

/* ุงูุจุฏุงูุฉ */
show('intro');
goSelectBtn.onclick = () => show('select');

/* ุจุฏุก ุจุงุฎุชูุงุฑ ููุงุทุน ูุชุนุฏุฏุฉ */
startMulti.onclick = () => {
  const checked = Array.from(document.querySelectorAll('#checks input[type=checkbox]:checked'))
                       .map(el => el.value);
  if (checked.length === 0) {
    alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุทุน ูุงุญุฏ ุนูู ุงูุฃูู.');
    return;
  }
  startMultiQuiz(checked);
};

function startMultiQuiz(keys){
  selectedKeys = keys;
  indicesMap = {};
  wordsMap = {};
  scores = {};
  currentPassageIdx = 0;
  currentQIdx = 0;

  // ุชุญุถูุฑ ูููุงุช ูู ููุทุน ูุงููุคุดุฑุงุช ุงูุนุดูุงุฆูุฉ ููู ููุทุน
  for (const k of selectedKeys){
    const w = PASSAGES[k].text.trim().split(/\s+/);
    wordsMap[k] = w;
    const maxStart = Math.max(0, w.length - (prefix + suffix));
    const need = Math.min(perPassageQuestions, maxStart); // ุฅุฐุง ูุงู ุงููุต ูุตูุฑูุง ุฌุฏูุง
    const inds = [];
    while (inds.length < need) {
      const r = Math.floor(Math.random() * Math.max(1, maxStart));
      if (!inds.includes(r)) inds.push(r);
      if (maxStart === 0) break; // ุญูุงูุฉ ูููุต ุงููุตูุฑ ุฌุฏูุง
    }
    indicesMap[k] = inds;
    scores[k] = {title: PASSAGES[k].title, correct: 0, total: inds.length};
  }

  // ุงูุชุญูู: ูู ููุฌุฏ ุนูู ุงูุฃูู ุณุคุงู ูุงุญุฏุ
  const totalQs = selectedKeys.reduce((s,k)=> s + indicesMap[k].length, 0);
  if (totalQs === 0){
    alert('ุงููุตูุต ุงููุฎุชุงุฑุฉ ูุตูุฑุฉ ุฌุฏูุง ุจุงููุณุจุฉ ูุฅุนุฏุงุฏุงุช ุงูุณุคุงู/ุงูุฅุฌุงุจุฉ. ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุทุน ุฃุทูู ุฃู ุชูููู ุงูุฅุนุฏุงุฏุงุช (ุฅู ูุงูุช ูุงุจูุฉ).');
    return;
  }

  show('quiz');
  renderCard();
}

/* ุนุฑุถ ุณุคุงู */
function renderCard(){
  // ุฅุฐุง ุงูุชูู ูุฐุง ุงูููุทุนุ ุงูุชูู ูุบูุฑู
  while (currentPassageIdx < selectedKeys.length &&
         currentQIdx >= indicesMap[selectedKeys[currentPassageIdx]].length) {
    currentPassageIdx++;
    currentQIdx = 0;
  }

  if (currentPassageIdx >= selectedKeys.length){
    finish();
    return;
  }

  const k = selectedKeys[currentPassageIdx];
  const title = PASSAGES[k].title;
  const words = wordsMap[k];
  const i = indicesMap[k][currentQIdx];

  const head = words.slice(i, i + prefix).join(' ');
  const tail = words.slice(i + prefix, i + prefix + suffix).join(' ');

  passageTitle.textContent = `ุงูููุทุน: ${title}`;
  questionText.innerHTML = `<b>${head}</b> <span class="hidden-ellipses">โฆ</span>`;
  answerText.textContent = tail;
  answerArea.style.display = 'none';

  // ุชูุฏูู: ุฑูู ุงูุณุคุงู ุงูุญุงูู ูู ุฅุฌูุงูู ุฃุณุฆูุฉ ูุฐุง ุงูููุทุน
  const cur = currentQIdx + 1;
  const tot = indicesMap[k].length;
  progressText.textContent = `ุณุคุงู ${cur} ูู ${tot} ูู ูุฐุง ุงูููุทุน`;

  // ูุคูุช
  clearInterval(timerId);
  remaining = timerSeconds;
  updateTimer();
  timerId = setInterval(tick, 1000);
}

function tick(){
  remaining--;
  updateTimer();
  if (remaining <= 0){
    clearInterval(timerId);
    beep.play();
    nextCard(false); // ุงูุชูู ุงูููุช = ูุง ุชูุถุงู ุฏุฑุฌุฉ
  }
}
function updateTimer(){ remainingEl.textContent = remaining.toString(); }

flipBtn.onclick = ()=>{ answerArea.style.display='block'; clearInterval(timerId); };
okBtn.onclick   = ()=>{ nextCard(true); };
badBtn.onclick  = ()=>{ nextCard(false); };

function nextCard(isCorrect){
  clearInterval(timerId);
  const k = selectedKeys[currentPassageIdx];
  if (isCorrect) scores[k].correct++;
  currentQIdx++;
  renderCard();
}

/* ุฅููุงุก ูุฅุธูุงุฑ ุงููุชุงุฆุฌ ุงูููุตูุฉ */
function finish(){
  show('result');
  breakdown.innerHTML = '';
  let totalCorrect = 0, totalQs = 0;

  for (const k of selectedKeys){
    const s = scores[k];
    totalCorrect += s.correct;
    totalQs += s.total;

    const li = document.createElement('li');
    li.textContent = `${s.title}: ${s.correct} ูู ${s.total}`;
    breakdown.appendChild(li);
  }

  finalScore.textContent = `ุงููุฌููุน ุงูููู: ${totalCorrect} ูู ${totalQs}`;
}

/* ุฅุนุงุฏุฉ */
backToSelect.onclick = ()=> {
  // ุฅุนุงุฏุฉ ุงููุงุฌูุฉ ููุงุฎุชูุงุฑ
  show('select');
};
repeatAll.onclick = ()=> {
  // ุฅุนุงุฏุฉ ููุณ ุงูุงุฎุชูุงุฑุงุช ุจุฌุฏูุฏ ูู ุงูุฃุณุฆูุฉ ุงูุนุดูุงุฆูุฉ
  startMultiQuiz(selectedKeys);
};

/* ุจุฏุก ุงูุชุทุจูู ุนูู ุตูุญุฉ ุงูุดุฑุญ */
show('intro');
</script>

</body>
</html>
